<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script>
      THREEx.ArToolkitContext.baseURL =
        "https://raw.githack.com/jeromeetienne/ar.js/master/three.js/";
    </script>
    <script
      src="https://kit.fontawesome.com/9a416a1cca.js"
      crossorigin="anonymous"
    ></script>
</head>

<link rel="stylesheet" href="./index.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />


<body style='margin: 0; overflow: hidden;'>



    <a-scene
        cursor='rayOrigin: mouse; fuse: true; fuseTimeout: 0;'
        raycaster="objects: [gps-entity-place];useWorldCoordinates:true"
        vr-mode-ui='enabled: false' 
            arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;'>

        
        <a-entity gltf-model="https://dylan1211-hub.github.io/smalltest/bus_test/assets/billboard/scene.gltf" rotation="0 35 0" scale="3 3 3" 
            gps-entity-place="longitude: 120.2274943919144 ; latitude:22.99841531128944" animation-mixer >

        <a-text value="Route Name" color="gray" zOffset="9999" anchor="left" 
                baseline="top" scale="0.3 0.3 0.3" position="-0.25 0.80 1">
        </a-text>
        <a-text value="19" color="#E6C35C" zOffset="9999" anchor="left" 
                baseline="top" scale="0.6 0.6 0.6" position="0.18 0.83 1">
        </a-text>
        <a-text value="Stop Name" color="gray" zOffset="9999" anchor="left" 
                baseline="top" scale="0.3 0.3 0.3" position="-0.25 0.65 1">
        </a-text>
        <a-text value="NCKU Hospital" color="#70C1CF" zOffset="9999" anchor="left" 
                baseline="top" scale="0.4 0.4 0.4" position="-0.2 0.55 1">
        </a-text>
        <a-text value="(xiaodong Road)" color="#70C1CF" zOffset="9999" anchor="left" 
                baseline="top" scale="0.4 0.4 0.4" position="-0.23 0.44 1">
        </a-text>
        <a-text value="Estimate Time" color="gray" zOffset="9999" anchor="left" 
                baseline="top" scale="0.3 0.3 0.3" position="-0.25 0.27 1">
        </a-text>
        <a-text value="3" color="#CD5C5C" zOffset="9999" anchor="left" 
                baseline="top" scale="0.8 0.8 0.8" position="0 0.15 1">
        </a-text>
        <a-text value="min" color="gray" zOffset="9999" anchor="left" 
                baseline="top" scale="0.3 0.3 0.3" position="0.15 0.09 1">
        </a-text>



        </a-entity>
        

        <a-camera gps-camera rotation-reader>
            <input type="checkbox"  id="side-menu-switch">
            <div class="side-menu">
                <label for="side-menu-switch">
                    <i class="fas fa-angle-left"></i>
                </label>
            </div>
        </a-camera>

	</a-scene>

    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>

        //取得使用者位置

        /*//計算自己到公車站牌的距離 lat1,lon1是自己的位置 lat2,lon2是公車站(出發地)的位置
        function distance(lat1, lon1, lat2, lon2) {
         if ((lat1 == lat2) && (lon1 == lon2)) {
            return 0;
        }   
        else {
        var radlat1 = Math.PI * lat1/180;
        var radlat2 = Math.PI * lat2/180;
        var theta = lon1-lon2;
        var radtheta = Math.PI * theta/180;
        var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        if (dist > 1) {
            dist = 1;
        }
        dist = Math.acos(dist);
        dist = dist * 180/Math.PI;
        dist = dist * 60 * 1.1515;
        dist = dist * 1.609344 
        return dist;
        }
    } 
    


        //介接的part

        var places=[];
        renderPlaces(places);


        //渲染的part
        function renderPlaces(places) {
          let scene = document.querySelector('a-scene');
          const latitude = 22.534673656027547;  
          const longitude = 120.45896646526651; 

          const billboard = document.createElement('a-entity');
          billboard.setAttribute('gps-entity-place', `latitude: ${latitude}; longitude: ${longitude}`);
          billboard.setAttribute('url','https://dylan1211-hub.github.io/smalltest/bus_test/assets/billboard/scene.gltf');
          billboard.setAttribute('rotation','0 ,0 ,0');
          billboard.setAttribute('scale','10,10,10');
          billboard.setAttribute('animation-mixer','')

          billboard.addEventListener('loaded', () => window.dispatchEvent(new CustomEvent('gps-entity-place-loaded')));

          const title = document.createElement('a-text');
            title.setAttribute('value', /*places[i].name);
            title.setAttribute('scale', '0.3 0.3 0.3');
            title.setAttribute('color','gray');
            title.setAttribute('zOffset','9999');
            title.setAttribute('anchor','left');
            title.setAttribute('baseline','top');
            title.setAttribute('position','-0.3 0.65 1')

            title.addEventListener('loaded', () => window.dispatchEvent(new CustomEvent('gps-entity-place-loaded')));
        
        
            scene.appendChild(billboard);
            billboard.appendChild(title);
        } */

        //OSM leaflet(web map)的part
        document.addEventListener('DOMContentLoaded', () => {  

        const zoo = [22.998593072090404, 120.2197879523883]; // 預設中心點為台北市動物園

        // 建立地圖
        const map = L.map('map', {
        attributionControl: false, // 是否秀出 leaflet
        zoomControl: false , // 是否秀出 - + 按鈕
        zoom: 17, // 0-18
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);



        // 建立 marker
        const customIcon = L.icon({
        iconUrl: 'https://letswritetw.github.io/letswrite-leaflet-osm-locate/dist/dot.svg',
        iconSize: [16, 16],
        });
        const marker = L.marker(zoo, {
        icon: customIcon,
        title: '跟 <a> 的 title 一樣', // 跟 <a> 的 title 一樣
        opacity: 1.0
        }).addTo(map);


        // 跟使用者要位置
        // 參考文件：https://leafletjs.com/examples/mobile/、https://leafletjs.com/reference-1.7.1.html#map-locate
        map.locate({ setView: true, watch: true, maxZoom: 18, enableHighAccuracy: true });

        // 使用者不提供位置
        function errorHandler(e) {
        console.log("e", e);
        window.alert('無法判斷您的所在位置，無法使用此功能。預設地點將為 測量系館');
        map.setView(zoo, 18); // 中心移到動物園
        moveTo(map); // 移動到指定座標（平滑 || 縮放 效果）
        panBy(map); // 移動 x, y 位置
        }
        map.on('locationerror', errorHandler);

        // 使用者提供位置
        function foundHandler(e) {
        console.log("e", e);
        marker.setLatLng(e.latlng); // 移動 marker
        map.setView(e.latlng, 17);
        moveTo(map); // 移動到指定座標（平滑 || 縮放 效果）
        panBy(map); // 移動 x, y 位置
        }
        map.on('locationfound', foundHandler);


        // 移動到指定座標（平滑 || 縮放 效果）
        function moveTo(map) {
        const btnPanto = document.querySelectorAll('.js-panto');
        Array.prototype.forEach.call(btnPanto, pan => {
            pan.addEventListener('click', e => {
            e.preventDefault();
            let latLng = e.target.dataset.to.split(',');
            let name = e.target.textContent;
            let toggleFly = document.getElementById('flyTo').checked;
            const popup = L.popup();
            popup
                .setLatLng(latLng)
                .setContent(`${name}`)
                .openOn(map);
            toggleFly ? map.flyTo(latLng) : map.panTo(latLng);
            })
        })
        }

        // 移動 x, y 位置
        function panBy(map) {
        const btnPanby = document.querySelectorAll('.js-panby');
        Array.prototype.forEach.call(btnPanby, pan => {
            pan.addEventListener('click', e => {
            e.preventDefault();
            let times = e.target.dataset.times;
            let point = 50 * times;
            let points = [point, point];
            map.panBy(points);
            })
        })
        }
        var MyIcon = L.icon({
        iconUrl: './assets/r.png',
        iconSize:     [10, 10], // size of the icon
        shadowSize:   [50, 64], // size of the shadow
        iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
        shadowAnchor: [4, 62],  // the same for the shadow
        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
        });

        L.geoJson(stores,{icon: MyIcon}).addTo(map);

        })
    </script>
   

</body>